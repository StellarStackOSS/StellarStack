# CI Pipeline — runs on all branches and merge requests
# Uses Turborepo for caching and parallel task execution

# ─── Install ────────────────────────────────────────────────────────
install:
  extends:
    - .node-setup
    - .ci-rules
  stage: install
  cache:
    - key:
        files:
          - pnpm-lock.yaml
      paths:
        - node_modules/
        - apps/*/node_modules/
        - packages/*/node_modules/
      policy: pull-push
    - key: turbo-${CI_COMMIT_REF_SLUG}
      paths:
        - .turbo/
      policy: pull-push
  script:
    - pnpm install --frozen-lockfile

# ─── Pre-build (typecheck + lint via Turbo) ──────────────────────
pre-build:
  extends:
    - .node-setup
    - .ci-rules
  stage: pre-build
  needs: [install]
  script:
    - pnpm turbo typecheck lint --env-mode=loose

# ─── Build (all apps via Turbo) ──────────────────────────────────
build:
  extends:
    - .node-setup
    - .ci-rules
  stage: build
  needs: [pre-build]
  script:
    - pnpm turbo build --env-mode=loose

# ─── Test (jsdom — packages/ui) ────────────────────────────────────
test-jsdom:
  extends:
    - .node-setup
    - .ci-rules
  stage: test
  needs: [build]
  script:
    - pnpm test:jsdom

# ─── Test (happy-dom — apps/web) ───────────────────────────────────
test-dom:
  extends:
    - .node-setup
    - .ci-rules
  stage: test
  needs: [build]
  script:
    - pnpm test:dom

# ─── Test (node — apps/api) ────────────────────────────────────────
test-node:
  extends:
    - .node-setup
    - .ci-rules
  stage: test
  needs: [build]
  script:
    - pnpm test:node

# ─── Code Analysis ─────────────────────────────────────────────────
code-analysis:
  extends:
    - .node-setup
    - .ci-rules
  stage: analysis
  needs: [test-jsdom, test-dom, test-node]
  script:
    - pnpm jscpd --pattern "apps/api/src/**/*.ts" --pattern "apps/web/**/*.{ts,tsx}" --pattern "apps/home/**/*.{ts,tsx}" --pattern "packages/ui/src/**/*.{ts,tsx}" --ignore "**/node_modules/**" --ignore "**/.next/**" --ignore "**/dist/**" --ignore "**/stories/**" --threshold 5
    - pnpm format:check

# ─── Railway helper functions ──────────────────────────────────────
# Uses GraphQL API for environment management (avoids railway link issues)
# and railway CLI with --project flag for deploys.

.railway-deploy-script: &railway-deploy-script
  - npm install -g @railway/cli
  - SLUG=$(echo "$CI_COMMIT_REF_SLUG" | cut -c1-30)
  - RAILWAY_API="https://backboard.railway.com/graphql/v2"
  - |
    railway_gql() {
      curl -sf -X POST "$RAILWAY_API" \
        -H "Authorization: Bearer $RAILWAY_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$1"
    }
  - |
    get_env_id() {
      railway_gql "{\"query\":\"{ environments(projectId: \\\"$RAILWAY_PROJECT_ID\\\") { edges { node { id name } } } }\"}" \
        | jq -r ".data.environments.edges[] | select(.node.name == \"$1\") | .node.id"
    }
  - |
    delete_env() {
      ENV_ID=$(get_env_id "$1")
      if [ -n "$ENV_ID" ]; then
        railway_gql "{\"query\":\"mutation { environmentDelete(id: \\\"$ENV_ID\\\") }\"}" > /dev/null
        echo "Deleted environment $1"
      fi
    }
  - |
    create_env() {
      railway_gql "{\"query\":\"mutation { environmentCreate(input: { name: \\\"$1\\\", projectId: \\\"$RAILWAY_PROJECT_ID\\\" }) { id name } }\"}" \
        | jq -r '.data.environmentCreate.name'
    }

# ─── Deploy Preview (Railway) ──────────────────────────────────────
deploy-preview:
  stage: deploy
  image: node:${NODE_VERSION}
  needs: [code-analysis]
  variables:
    RAILWAY_API_TOKEN: $RAILWAY_TOKEN
  script:
    - *railway-deploy-script
    - ENV_NAME="preview-${SLUG}"
    - delete_env "$ENV_NAME"
    - create_env "$ENV_NAME"
    - railway up --project "$RAILWAY_PROJECT_ID" --service web --environment "$ENV_NAME" --detach
    - railway up --project "$RAILWAY_PROJECT_ID" --service api --environment "$ENV_NAME" --detach
    - railway up --project "$RAILWAY_PROJECT_ID" --service home --environment "$ENV_NAME" --detach
    - echo "Deployed preview environment ${ENV_NAME}"
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    auto_stop_in: 15 minutes
    on_stop: cleanup-preview
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# ─── Deploy Dev (Railway — manual) ────────────────────────────────
deploy-dev:
  stage: deploy
  image: node:${NODE_VERSION}
  needs: [code-analysis]
  variables:
    RAILWAY_API_TOKEN: $RAILWAY_TOKEN
  script:
    - *railway-deploy-script
    - ENV_NAME="dev-${SLUG}"
    - delete_env "$ENV_NAME"
    - create_env "$ENV_NAME"
    - railway up --project "$RAILWAY_PROJECT_ID" --service web --environment "$ENV_NAME" --detach
    - railway up --project "$RAILWAY_PROJECT_ID" --service api --environment "$ENV_NAME" --detach
    - railway up --project "$RAILWAY_PROJECT_ID" --service home --environment "$ENV_NAME" --detach
    - echo "Deployed dev environment ${ENV_NAME}"
  environment:
    name: dev/$CI_COMMIT_REF_SLUG
    on_stop: cleanup-dev
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# ─── Cleanup Preview ───────────────────────────────────────────────
cleanup-preview:
  stage: cleanup
  image: node:${NODE_VERSION}
  variables:
    GIT_STRATEGY: none
  script:
    - SLUG=$(echo "$CI_COMMIT_REF_SLUG" | cut -c1-30)
    - RAILWAY_API="https://backboard.railway.com/graphql/v2"
    - |
      ENV_ID=$(curl -sf -X POST "$RAILWAY_API" \
        -H "Authorization: Bearer $RAILWAY_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"query\":\"{ environments(projectId: \\\"$RAILWAY_PROJECT_ID\\\") { edges { node { id name } } } }\"}" \
        | jq -r ".data.environments.edges[] | select(.node.name == \"preview-${SLUG}\") | .node.id")
    - |
      if [ -n "$ENV_ID" ]; then
        curl -sf -X POST "$RAILWAY_API" \
          -H "Authorization: Bearer $RAILWAY_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"query\":\"mutation { environmentDelete(id: \\\"$ENV_ID\\\") }\"}"
        echo "Deleted preview-${SLUG}"
      fi
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    action: stop
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# ─── Cleanup Dev ──────────────────────────────────────────────────
cleanup-dev:
  stage: cleanup
  image: node:${NODE_VERSION}
  variables:
    GIT_STRATEGY: none
  script:
    - SLUG=$(echo "$CI_COMMIT_REF_SLUG" | cut -c1-30)
    - RAILWAY_API="https://backboard.railway.com/graphql/v2"
    - |
      ENV_ID=$(curl -sf -X POST "$RAILWAY_API" \
        -H "Authorization: Bearer $RAILWAY_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"query\":\"{ environments(projectId: \\\"$RAILWAY_PROJECT_ID\\\") { edges { node { id name } } } }\"}" \
        | jq -r ".data.environments.edges[] | select(.node.name == \"dev-${SLUG}\") | .node.id")
    - |
      if [ -n "$ENV_ID" ]; then
        curl -sf -X POST "$RAILWAY_API" \
          -H "Authorization: Bearer $RAILWAY_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"query\":\"mutation { environmentDelete(id: \\\"$ENV_ID\\\") }\"}"
        echo "Deleted dev-${SLUG}"
      fi
  environment:
    name: dev/$CI_COMMIT_REF_SLUG
    action: stop
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true
