# Docker Image Build & Release Pipeline
# Equivalent to the old .github/workflows/docker-build.yml
#
# Triggered by release tags (v*), repository dispatch, or manual trigger.
# Builds API and Web Docker images, pushes to Docker Hub, signs with Cosign.

.docker-build-rules:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d/
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "trigger"

docker-build:
  extends: .docker-build-rules
  stage: release
  image: docker:latest
  services:
    - docker:dind
  tags:
    - self-hosted
  parallel:
    matrix:
      - SERVICE: api
        DOCKERFILE: docker/cores/api/Dockerfile
        IMAGE_NAME: stellarstack-api
      - SERVICE: web
        DOCKERFILE: docker/cores/web/Dockerfile
        IMAGE_NAME: stellarstack-web
  variables:
    DOCKER_HUB_ORG: stellarstackoss
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache curl bash coreutils jq
  script:
    # Resolve version
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="${CI_COMMIT_TAG#v}"
      elif [ -n "$VERSION" ]; then
        VERSION="$VERSION"
      else
        echo "No version found" && exit 1
      fi
      TAG="v${VERSION}"
      IMAGE="${DOCKER_HUB_ORG}/${IMAGE_NAME}"

    # Login to Docker Hub
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

    # Build
    - |
      BUILD_ARGS=""
      if [ "$SERVICE" = "web" ]; then
        BUILD_ARGS="--build-arg NEXT_PUBLIC_GIT_COMMIT_HASH=${CI_COMMIT_SHA}"
      fi
      docker build $BUILD_ARGS \
        --tag "${IMAGE}:${TAG}" \
        --tag "${IMAGE}:latest" \
        --label "org.opencontainers.image.title=${IMAGE_NAME}" \
        --label "org.opencontainers.image.version=${VERSION}" \
        --label "org.opencontainers.image.vendor=StellarStack" \
        -f "$DOCKERFILE" .

    # Push
    - docker push "${IMAGE}:${TAG}"
    - docker push "${IMAGE}:latest"

    # Export image tarball
    - docker save "${IMAGE}:${TAG}" | gzip > "${SERVICE}-linux-amd64.tar.gz"
    - sha256sum "${SERVICE}-linux-amd64.tar.gz" > "${SERVICE}-linux-amd64.tar.gz.sha256"

    # Generate SBOM
    - |
      curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      syft "${IMAGE}:${TAG}" -o spdx-json > "${SERVICE}-sbom.spdx.json"

    # Sign with Cosign
    - |
      curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /usr/local/bin/cosign
      chmod +x /usr/local/bin/cosign
      COSIGN_EXPERIMENTAL=true cosign sign --yes "${IMAGE}:${TAG}"

    - echo "${SERVICE} released â€” ${IMAGE}:${TAG}"
  artifacts:
    paths:
      - ${SERVICE}-linux-amd64.tar.gz
      - ${SERVICE}-linux-amd64.tar.gz.sha256
      - ${SERVICE}-sbom.spdx.json
    expire_in: 7 days
