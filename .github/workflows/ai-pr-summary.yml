name: AI PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && secrets.OLLAMA_URL != ''
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff and Context
        id: context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Get PR details
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
          AUTHOR=$(gh pr view $PR_NUMBER --json author --json 'author.login' -q '.author.login')
          LABELS=$(gh pr view $PR_NUMBER --json labels -q '.labels[].name' | paste -sd ',' - || echo "")

          # Get diff (limit to 5000 lines to avoid token limits)
          DIFF=$(gh pr diff $PR_NUMBER | head -5000)

          # Get commit messages
          COMMITS=$(gh pr view $PR_NUMBER --json commits -q '.commits[].messageHeadline' | paste -sd '|' -)

          # Extract changed files
          FILES=$(gh pr view $PR_NUMBER --json files -q '.files[].path' | paste -sd ',' - || echo "")

          # Save to environment for next step
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

          # Save diff to file
          echo "$DIFF" > /tmp/pr_diff.txt

      - name: Generate AI Summary
        id: ai_summary
        env:
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
        run: |
          # Build comprehensive prompt
          PR_TITLE="${{ steps.context.outputs.pr_title }}"
          AUTHOR="${{ steps.context.outputs.author }}"
          LABELS="${{ steps.context.outputs.labels }}"
          FILES="${{ steps.context.outputs.files }}"
          COMMITS="${{ steps.context.outputs.commits }}"
          DIFF=$(cat /tmp/pr_diff.txt | head -2000)

          PROMPT=$(cat <<'PROMPT_EOF'
You are an AI assistant helping to write clear, comprehensive pull request summaries for software development teams.

## Context
PR Title: $PR_TITLE
Author: $AUTHOR
Labels: $LABELS
Files Changed: $FILES
Commit Messages: $COMMITS

## Code Diff (first 2000 lines)
$DIFF

## Your Task
Generate a professional PR summary with the following sections:

### Summary
Write 2-3 sentences explaining what changed and why. Focus on the business/user value.

### Changes
Create a bullet-point list (3-5 items) of the key changes made. Be specific and clear.

### Technical Details
Add any important implementation notes, architecture decisions, or technical considerations (2-3 sentences). Skip this if not applicable.

### Testing
Describe how this was tested or how it should be tested (1-2 sentences). Skip if obvious.

## Requirements
- Use clear, professional language
- Be concise but thorough
- Use markdown formatting
- Focus on clarity and understanding
- Avoid technical jargon where possible
- Emphasize user/developer value

Generate only the summary content without any preamble or explanation.
PROMPT_EOF
          )

          # Make prompt accessible to Ollama client script
          chmod +x .github/scripts/ollama-client.sh

          # Call Ollama with error handling
          SUMMARY=$(.github/scripts/ollama-client.sh "$PROMPT" "neural-chat" 2>&1 || echo "")

          if [ -z "$SUMMARY" ]; then
            echo "warn=true" >> $GITHUB_OUTPUT
            echo "summary=Unable to generate AI summary at this time. Ollama may be unavailable." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Save summary
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "warn=false" >> $GITHUB_OUTPUT

      - name: Update PR Description
        if: github.event.pull_request.draft == false
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CURRENT_BODY=$(gh pr view $PR_NUMBER --json body -q .body || echo "")

          # Check if AI summary already exists (avoid duplicates on subsequent updates)
          if echo "$CURRENT_BODY" | grep -q "ü§ñ AI-Generated Summary"; then
            echo "‚úì AI summary already exists, skipping update"
            exit 0
          fi

          # Check if summary generation failed
          if [ "${{ steps.ai_summary.outputs.warn }}" == "true" ]; then
            echo "‚ö†Ô∏è  AI summary generation failed, skipping PR update"
            exit 0
          fi

          # Prepare new body
          SUMMARY="${{ steps.ai_summary.outputs.summary }}"

          if [ -z "$CURRENT_BODY" ]; then
            CURRENT_BODY="(No description provided)"
          fi

          # Append new summary
          NEW_BODY="$CURRENT_BODY

---

## ü§ñ AI-Generated Summary

$SUMMARY

<sub>Generated by neural-chat via Ollama</sub>"

          # Update PR description
          gh pr edit $PR_NUMBER --body "$NEW_BODY" || {
            echo "‚ö†Ô∏è  Failed to update PR description"
            exit 0
          }

          echo "‚úì Successfully updated PR with AI summary"

      - name: Report Status
        if: always()
        run: |
          if [ "${{ steps.ai_summary.outputs.warn }}" == "true" ]; then
            echo "‚ö†Ô∏è  AI Summary Generation Failed"
            echo "The Ollama instance may be unavailable or not properly configured."
            echo "Please check OLLAMA_URL secret in GitHub settings."
          else
            echo "‚úì AI Summary Generated Successfully"
          fi
