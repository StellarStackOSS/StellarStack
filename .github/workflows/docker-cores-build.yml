name: Build Core Docker Images

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. 1.2.3)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/stellarstack-core

jobs:
  # Discover all core Dockerfiles dynamically
  discover-cores:
    name: Discover Cores
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      has_cores: ${{ steps.discover.outputs.has_cores }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Discover core Dockerfiles
        id: discover
        run: |
          # Find all Dockerfiles under docker/cores, excluding api and web
          DOCKERFILES=$(find docker/cores -name "Dockerfile" -type f | grep -v "docker/cores/api" | grep -v "docker/cores/web" | sort)

          if [ -z "$DOCKERFILES" ]; then
            echo "No core Dockerfiles found"
            echo "has_cores=false" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_cores=true" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles:"
          echo "$DOCKERFILES"

          # Build the matrix JSON
          MATRIX="["
          FIRST=true

          for DOCKERFILE in $DOCKERFILES; do
            # Extract path components
            # e.g., docker/cores/java/11/Dockerfile -> java/11
            RELATIVE_PATH=$(echo "$DOCKERFILE" | sed 's|docker/cores/||' | sed 's|/Dockerfile$||')

            # Get the runtime (e.g., java, nodejs)
            RUNTIME=$(echo "$RELATIVE_PATH" | cut -d'/' -f1)

            # Get the version (e.g., 8, 11, 16)
            VERSION=$(echo "$RELATIVE_PATH" | cut -d'/' -f2)

            # Context is the parent directory containing entrypoint.sh
            CONTEXT="docker/cores/$RUNTIME"

            # Image name: java-11, nodejs-16
            IMAGE_NAME="${RUNTIME}-${VERSION}"

            # Job name: java-11, nodejs-16
            JOB_NAME="${RUNTIME}-${VERSION}"

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX="$MATRIX,"
            fi

            MATRIX="$MATRIX{\"runtime\":\"$RUNTIME\",\"version\":\"$VERSION\",\"dockerfile\":\"$DOCKERFILE\",\"context\":\"$CONTEXT\",\"image_name\":\"$IMAGE_NAME\",\"job_name\":\"$JOB_NAME\"}"
          done

          MATRIX="$MATRIX]"

          echo "Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### Core Discovery Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cores found:** ${{ steps.discover.outputs.has_cores }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.discover.outputs.matrix }}' | jq '.' >> $GITHUB_STEP_SUMMARY || echo '${{ steps.discover.outputs.matrix }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Build each discovered core
  build-cores:
    name: Build ${{ matrix.job_name }}
    needs: discover-cores
    if: needs.discover-cores.outputs.has_cores == 'true'
    # Use GitHub-hosted runner rather than a custom self-hosted runner
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-cores.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            TAG="${{ github.event.release.tag_name }}"
            VERSION="${TAG#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image_name }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=stellarstack-core-${{ matrix.image_name }}
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.vendor=StellarStack
            org.opencontainers.image.description=StellarStack ${{ matrix.runtime }} ${{ matrix.version }} runtime core

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.job_name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.job_name }}

      - name: Summary
        run: |
          echo "### ${{ matrix.job_name }} built ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Runtime:** ${{ matrix.runtime }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ matrix.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image_name }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
