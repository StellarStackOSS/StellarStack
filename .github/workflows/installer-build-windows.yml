name: Build Installer - Windows

on:
  push:
    tags:
      - 'installer-v*'
    paths:
      - 'Installer/**'
      - '.github/workflows/installer-build-windows.yml'
  pull_request:
    paths:
      - 'Installer/**'
  workflow_dispatch:

env:
  BINARY_NAME: stellarstack-installer
  GO_VERSION: '1.25.6'

jobs:
  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        working-directory: Installer
        env:
          GOOS: windows
          GOARCH: amd64
        shell: pwsh
        run: |
          go build -o stellarstack-installer-windows-x86_64.exe -ldflags="-s -w" main.go
          Get-Item stellarstack-installer-windows-x86_64.exe | Format-List
          Write-Host "File info:" (file stellarstack-installer-windows-x86_64.exe)

      - name: Verify binary
        working-directory: Installer
        shell: pwsh
        run: |
          .\stellarstack-installer-windows-x86_64.exe --version
          .\stellarstack-installer-windows-x86_64.exe --help | Select-Object -First 20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: stellarstack-installer-windows-x86_64.exe
          path: Installer/stellarstack-installer-windows-x86_64.exe
          if-no-files-found: error

  test:
    name: Test Windows Build
    needs: build-windows
    runs-on: windows-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Test binary
        shell: pwsh
        run: |
          Get-ChildItem -Path binaries -Recurse -Filter "*.exe" | ForEach-Object {
            Write-Host "Testing: $($_.Name)"
            & $_.FullName --version
            if ($LASTEXITCODE -ne 0) {
              throw "Binary test failed: $($_.Name)"
            }
          }

  checksums:
    name: Generate Windows Checksums
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          mkdir -p release
          for dir in artifacts/*/; do
            name=$(basename "$dir")
            cp "$dir$name" "release/$name"
          done
          cd release
          sha256sum * > windows-checksums.txt
          cat windows-checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: windows-checksums.txt
          path: release/windows-checksums.txt
          if-no-files-found: ignore
